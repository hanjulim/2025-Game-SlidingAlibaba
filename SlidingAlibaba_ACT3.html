<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•Œë¦¬ë°”ë°”ì˜ ê¸´ê¸‰ íƒˆì¶œ: Act 3 (ì§€ë‹ˆì˜ ë„ì›€)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap');
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #2c2c2c;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        #game-container {
            background-color: #1a1a1a;
            border: 6px solid #0ea5e9; /* Act 3: Genie's Blue/Cyan Theme */
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.7);
            border-radius: 16px;
            padding: 20px;
            color: white;
            max-width: 400px;
            width: 100%;
            transition: all 0.3s ease-in-out;
        }
        #status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 15px;
            background-color: #333;
            border-radius: 8px;
            box-shadow: inset 0 0 5px rgba(255, 255, 255, 0.1);
        }
        #timer {
            font-size: 1.8rem;
            font-weight: 900;
            color: #ffeb3b;
            min-width: 40px;
            text-align: right;
        }
        #message {
            min-height: 60px;
            padding: 10px;
            border-radius: 8px;
            font-size: 1rem;
            text-align: center;
            margin-bottom: 15px;
            font-weight: 700;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin: 0 auto;
        }
        
        .tile {
            width: 100%;
            padding-top: 100%;
            height: 0;
            position: relative;
            display: block;
            cursor: pointer;
            border-radius: 6px;
            transition: transform 0.2s, background-color 0.2s;
            user-select: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }
        
        .tile-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 28px;
        }
        
        /* --- Tile Definitions --- */
        .tile.player { background-color: #e53e3e; color: white; border: 3px solid #f6ad55; animation: pulse 1s infinite alternate; }
        .tile.path-stone { background-color: #4a5568; color: #cbd5e0; border: 2px solid #555; }
        .tile.empty { background-color: #1a1a1a; cursor: default; box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.8); border: 1px dashed #444; }
        
        /* --- Exit Styles (Fixed at Bottom Right) --- */
        /* Active Exit (Gold Border) - Applied to whatever tile is at (3,3) */
        .tile.exit-active-marker { 
            border: 4px solid #ffeb3b; /* Gold */
            box-shadow: 0 0 15px #ffd700;
            animation: glow 1.5s infinite alternate; 
        }
        .tile.exit-active-marker .tile-content::after {
            content: 'ğŸšª';
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 14px;
        }
        /* When A is successfully on the exit tile */
        .tile.player-on-exit {
            background-color: #27ae60 !important; /* Greenish for success */
            border: 4px solid #ffeb3b !important;
            box-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700;
        }

        /* Interactions */
        .tile:not(.empty):hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }
        .tile.can-slide { border: 3px solid #00bfff; }
        
        /* --- ì œê±°ëœ ìŠ¤íƒ€ì¼ ---
        .tile.can-enter-exit { border: 4px solid #38aa69 !important; transform: scale(1.05); cursor: grab; }
        */

        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.03); } }
        @keyframes glow { from { box-shadow: 0 0 5px #ffeb3b, 0 0 10px #ffeb3b; } to { box-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700; } }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0, 0, 0, 0.8); display: flex; 
            justify-content: center; align-items: center; z-index: 1000;
        }
    </style>
</head>
<body class="selection:bg-yellow-300 selection:text-gray-800">

    <div id="game-container">
        <h1 class="text-3xl font-black text-center text-sky-400 mb-2">ğŸ§â€â™‚ï¸ Act 3: ì§€ë‹ˆì˜ ë„ì›€</h1>
        <p class="text-sm text-center text-gray-400 mb-4">ì§€ë‹ˆê°€ ì¶œêµ¬ë¥¼ ì—´ì–´ì£¼ì—ˆìŠµë‹ˆë‹¤! ì•Œë¦¬ë°”ë°”ë¥¼ **ìš°ì¸¡ í•˜ë‹¨ ì¶œêµ¬**ë¡œ ë°”ë¡œ ì´ë™ì‹œí‚¤ì„¸ìš”.</p>

        <div id="status-bar">
            <span class="text-sm font-medium text-gray-300">ì‹œê°„ ì œí•œ:</span>
            <span id="timer">âˆ</span> <!-- ë¬´ì œí•œ í‘œì‹œ -->
        </div>

        <div id="message" class="bg-gray-700 text-gray-200"></div>

        <div id="grid-container"></div>

        <div id="controls-buttons" class="mt-5">
            <button id="reset-button" class="control-button w-full bg-sky-700 hover:bg-sky-800 text-white p-3 rounded-lg font-bold shadow-lg transition duration-150">ğŸ”„ ê²Œì„ ì¬ì‹œì‘</button>
        </div>
    </div>
    
    <div id="game-modal"></div>

    <script>
        // ìƒìˆ˜ ì •ì˜
        const GRID_SIZE = 4;
        const EXIT_POS = { r: 3, c: 3 }; 
        
        // ê²Œì„ ìƒíƒœ ë³€ìˆ˜
        let grid = [];
        let playerPos = { r: 0, c: 0 };
        let emptyPos = { r: 0, c: 0 };
        let isExitUnlocked = true; // Act 3: Always Unlocked
        let timerInterval;
        let isGameActive = false;

        // íƒ€ì¼ ì •ì˜ (ì£¼ë¬¸ íƒ€ì¼ ì—†ì´ A, S, 0 ë§Œ ì‚¬ìš©)
        const TILE_DEFS = {
            'A': { display: 'A', class: 'player' },
            'S': { display: 'ğŸ—¿', class: 'path-stone' },
            '0': { display: '', class: 'empty' }
        };

        // DOM ìš”ì†Œ ìºì‹œ
        const gridContainer = document.getElementById('grid-container');
        const messageElement = document.getElementById('message');
        const timerElement = document.getElementById('timer');
        const resetButton = document.getElementById('reset-button');
        const gameModal = document.getElementById('game-modal');

        /**
         * ê²Œì„ ì´ˆê¸° ìƒíƒœë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
         */
        function initializeGame() {
            stopTimer();
            isGameActive = true;
            isExitUnlocked = true; 
            
            // ì‹œê°„ ë¬´ì œí•œ ì„¤ì •
            timerElement.textContent = "âˆ";
            timerElement.classList.remove('text-red-500');
            
            grid = generateSolvableGrid();
            drawGrid();
            startTimer(); // íƒ€ì´ë¨¸ëŠ” ë¬´ì œí•œ ìƒíƒœë¡œ ìœ ì§€
            
            displayMessage('íƒ€ì¼ì„ ë°€ì–´ ì•Œë¦¬ë°”ë°”(A)ë¥¼ í™©ê¸ˆìƒ‰ ì¶œêµ¬(ğŸšª)ë¡œ ì´ë™ì‹œí‚¤ì„¸ìš”.', 'bg-gray-700 text-gray-200');
            closeModal();
        }

        /**
         * í¼ì¦ì˜ ì´ˆê¸° ë°°ì¹˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
         * @returns {string[][]} ì´ˆê¸° ê·¸ë¦¬ë“œ ë°°ì—´
         */
        function generateSolvableGrid() {
            // íƒ€ì¼ êµ¬ì„±: A(1), 0(1), S(14) = 16ê°œ (ì£¼ë¬¸ íƒ€ì¼ ì—†ìŒ)
            let requiredTiles = ['A', '0'];
            for(let i=0; i<14; i++) requiredTiles.push('S');

            // ì„ê¸°
            requiredTiles.sort(() => Math.random() - 0.5);

            let currentGrid = [];
            let idx = 0;
            for (let r = 0; r < GRID_SIZE; r++) {
                currentGrid[r] = [];
                for (let c = 0; c < GRID_SIZE; c++) {
                    let tile = requiredTiles[idx++];
                    currentGrid[r][c] = tile;
                    if (tile === 'A') playerPos = { r, c };
                    if (tile === '0') emptyPos = { r, c };
                }
            }
            return currentGrid;
        }

        /**
         * íƒ€ì´ë¨¸ë¥¼ ì‹œì‘/ìœ ì§€í•©ë‹ˆë‹¤. (Act 3ì—ì„œëŠ” ë¬´ì œí•œ)
         */
        function startTimer() {
            stopTimer();
            // ë¬´ì œí•œì´ë¯€ë¡œ ì‹œê°„ ê°ì†Œ ë¡œì§ ì œê±°
            timerInterval = setInterval(() => {
                if (!isGameActive) return;
            }, 1000);
        }

        /**
         * íƒ€ì´ë¨¸ë¥¼ ë©ˆì¶¥ë‹ˆë‹¤.
         */
        function stopTimer() {
            clearInterval(timerInterval);
        }

        /**
         * íƒ€ì¼ ìŠ¬ë¼ì´ë”© ë° ìŠ¹ë¦¬ ì¡°ê±´ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
         * @param {number} r í´ë¦­ëœ íƒ€ì¼ì˜ í–‰ ì¸ë±ìŠ¤
         * @param {number} c í´ë¦­ëœ íƒ€ì¼ì˜ ì—´ ì¸ë±ìŠ¤
         */
        function handleSlide(r, c) {
            if (!isGameActive) return;

            const tileKey = grid[r][c];
            
            // --- Win Condition Check: ì•Œë¦¬ë°”ë°”ê°€ í™œì„±í™”ëœ ì¶œêµ¬ë¡œ "íŠ¹ìˆ˜ ì´ë™"í•  ë•Œ ---
            if (isExitUnlocked && tileKey === 'A') {
                const dr = Math.abs(playerPos.r - EXIT_POS.r);
                const dc = Math.abs(playerPos.c - EXIT_POS.c);
                // ì•Œë¦¬ë°”ë°”ê°€ ì¶œêµ¬ (3,3)ì— ì¸ì ‘í•œ ìœ„ì¹˜ì— ìˆëŠ”ì§€ í™•ì¸
                const isAdjacentToExit = (dr === 1 && dc === 0) || (dr === 0 && dc === 1);

                if (isAdjacentToExit) {
                    // ìŠ¹ë¦¬ ì²˜ë¦¬ (Aê°€ ì¶œêµ¬ë¡œ ë“¤ì–´ê°)
                    grid[EXIT_POS.r][EXIT_POS.c] = 'A'; 
                    grid[playerPos.r][playerPos.c] = '0'; // Aê°€ ìˆë˜ ìë¦¬ëŠ” ë¹ˆì¹¸ì´ ë¨
                    drawGrid();
                    handleWin(`ğŸ‰ íƒˆì¶œ ì„±ê³µ! ì§€ë‹ˆì˜ ë„ì›€ìœ¼ë¡œ ë™êµ´ì„ ì‰½ê²Œ ë¹ ì ¸ë‚˜ì™”ìŠµë‹ˆë‹¤!`);
                    return;
                }
            }

            // --- Standard Sliding Logic ---
            if (tileKey === '0') return; // ë¹ˆì¹¸ì€ í´ë¦­í•´ë„ ì•„ë¬´ ì¼ ì—†ìŒ

            // ë¹ˆì¹¸ê³¼ í´ë¦­ëœ íƒ€ì¼ì˜ ì¸ì ‘ì„± í™•ì¸
            const dr = Math.abs(r - emptyPos.r);
            const dc = Math.abs(c - emptyPos.c);
            const isAdjacent = (dr === 1 && dc === 0) || (dr === 0 && dc === 1);

            if (isAdjacent) {
                // íƒ€ì¼ê³¼ ë¹ˆì¹¸ ìœ„ì¹˜ êµí™˜ (ìŠ¬ë¼ì´ë”©)
                const newEmptyPos = { r, c };
                const newPlayerPos = { r: emptyPos.r, c: emptyPos.c };

                grid[emptyPos.r][emptyPos.c] = tileKey;
                grid[r][c] = '0';
                
                if (tileKey === 'A') playerPos = newPlayerPos;
                emptyPos = newEmptyPos;

                // ì•Œë¦¼ ë©”ì‹œì§€ ì œê±° ìš”ì²­ì— ë”°ë¼ ì¼ë°˜ ë©”ì‹œì§€ë§Œ ìœ ì§€
                displayMessage('íƒ€ì¼ì„ ë°€ì–´ ì•Œë¦¬ë°”ë°”ë¥¼ ìš°ì¸¡ í•˜ë‹¨ ì¶œêµ¬ë¡œ ì´ë™ì‹œí‚¤ì„¸ìš”.', 'bg-gray-700 text-gray-200');
                
                drawGrid();
            } else {
                displayMessage('ë¹ˆì¹¸ ì˜†ì˜ íƒ€ì¼ë§Œ ë°€ ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'bg-gray-700 text-gray-200');
            }
        }

        /**
         * ê²Œì„ ë³´ë“œë¥¼ í™”ë©´ì— ê·¸ë¦½ë‹ˆë‹¤.
         */
        function drawGrid() {
            gridContainer.innerHTML = '';
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    const key = grid[r][c];
                    const def = TILE_DEFS[key] || TILE_DEFS['0'];
                    const tileDiv = document.createElement('div');
                    tileDiv.className = `tile ${def.class}`;
                    
                    // 1. ì¶œêµ¬ ë§ˆì»¤ í‘œì‹œ (3,3 ìœ„ì¹˜) - í•­ìƒ í™©ê¸ˆìƒ‰ í™œì„±í™” ìƒíƒœ
                    if (r === EXIT_POS.r && c === EXIT_POS.c) {
                        tileDiv.classList.add('exit-active-marker'); 
                        
                        // 2. ì•Œë¦¬ë°”ë°”ê°€ ì¶œêµ¬ ìœ„ì¹˜ì— ìˆìœ¼ë©´ ìŠ¹ë¦¬ ì—°ì¶œ
                        if (key === 'A') {
                            tileDiv.classList.remove('player');
                            tileDiv.classList.add('player-on-exit');
                        }
                    }

                    // 3. ì•Œë¦¬ë°”ë°” íƒˆì¶œ ê°€ëŠ¥ í‘œì‹œ ì œê±° (can-enter-exit í´ë˜ìŠ¤ ì œê±°)
                    /*
                    if (key === 'A') {
                        const dr = Math.abs(r - EXIT_POS.r);
                        const dc = Math.abs(c - EXIT_POS.c);
                        if ((dr === 1 && dc === 0) || (dr === 0 && dc === 1)) {
                            tileDiv.classList.add('can-enter-exit'); 
                        }
                    }
                    */

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'tile-content';
                    contentDiv.textContent = def.display;
                    tileDiv.appendChild(contentDiv);

                    // ìŠ¬ë¼ì´ë“œ ê°€ëŠ¥ í‘œì‹œ (íŒŒë€ìƒ‰ í…Œë‘ë¦¬)
                    const dr = Math.abs(r - emptyPos.r);
                    const dc = Math.abs(c - emptyPos.c);
                    const isAdjacent = (dr === 1 && dc === 0) || (dr === 0 && dc === 1);
                    
                    if (isAdjacent && key !== '0') {
                        tileDiv.classList.add('can-slide');
                    }

                    tileDiv.addEventListener('click', () => handleSlide(r, c));
                    gridContainer.appendChild(tileDiv);
                }
            }
        }

        /**
         * ìƒíƒœ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
         * @param {string} msg í‘œì‹œí•  ë©”ì‹œì§€
         * @param {string} className Tailwind CSS í´ë˜ìŠ¤
         */
        function displayMessage(msg, className) {
            messageElement.className = `font-semibold p-2 rounded-lg ${className}`;
            messageElement.innerHTML = msg;
        }

        /**
         * ìŠ¹ë¦¬ ì‹œ ê²Œì„ ì¢…ë£Œ ì²˜ë¦¬ë¥¼ í•©ë‹ˆë‹¤.
         * @param {string} msg ëª¨ë‹¬ì— í‘œì‹œí•  ë©”ì‹œì§€
         */
        function handleWin(msg) {
            isGameActive = false;
            stopTimer();
            displayModal('íƒˆì¶œ ì„±ê³µ!', msg, 'bg-green-600');
        }

        // ê²Œì„ ì˜¤ë²„ëŠ” ì‹œê°„ ë¬´ì œí•œìœ¼ë¡œ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ

        /**
         * ëª¨ë‹¬ ì°½ì„ í‘œì‹œí•©ë‹ˆë‹¤.
         * @param {string} title ëª¨ë‹¬ ì œëª©
         * @param {string} msg ëª¨ë‹¬ ë‚´ìš©
         * @param {string} headerClass ëª¨ë‹¬ í—¤ë” ë°°ê²½ìƒ‰ í´ë˜ìŠ¤
         */
        function displayModal(title, msg, headerClass) {
            gameModal.innerHTML = `
                <div class="modal">
                    <div class="bg-white p-8 rounded-lg text-center w-11/12 max-w-sm text-gray-900">
                        <h3 class="text-2xl font-black mb-4 p-2 rounded ${headerClass} text-white">${title}</h3>
                        <p class="mb-6">${msg}</p>
                        <button onclick="initializeGame()" class="control-button w-full bg-sky-700 text-white p-3 rounded font-bold">ë‹¤ì‹œ ë„ì „</button>
                    </div>
                </div>`;
        }

        /**
         * ëª¨ë‹¬ ì°½ì„ ë‹«ìŠµë‹ˆë‹¤.
         */
        function closeModal() { gameModal.innerHTML = ''; }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        resetButton.addEventListener('click', initializeGame);
        window.onload = initializeGame;
    </script>
</body>
</html>